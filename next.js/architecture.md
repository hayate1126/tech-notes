# 🏗️ Modern Feature-Sliced Architecture (App Router Era)

本プロジェクトでは、Next.js App Routerの特性を最大限に活かしつつ、大規模開発での保守性とテスタビリティを両立させた**「Feature-Driven Atomic Architecture」**を採用しています。

## 📂 フォルダ構成の決定版ツリー

```text
src/
 ├── app/                   # 【Server Layer】ルーティング & RSC
 │    └── users/[id]/       # 各ページのデータ取得とFeatureの配置に専念
 ├── features/              # 【Feature Layer】ドメインごとの「小さな島」
 │    └── user-profile/     # ユーザープロフィール機能 (カプセル化)
 │         ├── components/  # この機能専用のコンポーネント
 │         ├── hooks/       # Reactの状態・副作用 (Interface)
 │         ├── utils/     # 純粋関数によるビジネスルール (Domain Logic)
 │         ├── types/       # この機能専用の型定義
 │         ├── tests/       # テストファイル
 │         └── index.ts     # 【Public API】外部への公開インターフェース
 ├── components/            # 【Shared UI Layer】ドメイン知識ゼロの汎用部品
 │    └── ui/               # Button, Modal, Avatar等 (Shadcn/uiベース)
 ├── hooks/                 # 【Global Hooks】汎用的なロジック
 ├── lib/                   # 外部ライブラリの初期化 (Prisma, Supabase等)
 ├── stores/                   # ストア格納

 └── utils/                 # 純粋なユーティリティ関数

```

---

## 🎯 設計のコア原則

### 1. 「ドメイン」と「UI」の分離

コンポーネントを、その役割（語彙）によって明確に2層に分けています。

* **Shared UI(components):** アプリの目的を知らない抽象パーツ（Button, Avatar）。
* **Feature:** 「投稿」「ユーザー」といったビジネス上の意味（ドメイン）を持つ塊。非エンジニアと共通言語（ユビキタス言語）で話せる単位で分割しています。

### 2. ロジックの「ROI」に基づいた配置

認知負荷と保守性のバランスを取るため、ロジックを以下の3段階で管理しています。

* **View Logic:** UIの開閉などの表示制御は、Colocation（共配置）に基づきコンポーネント内に閉じ込めます。
* **Domain Logic:** 計算や判定などのビジネスルールは、Reactに依存しない**純粋関数**として `logic.ts` に抽出。100%のテストカバレッジを目指します。
* **Interface Hooks:** 状態管理や副作用（API接続）は**Custom Hooks**にカプセル化し、コンポーネントを宣言的に保ちます。

### 3. 公開APIによるカプセル化 (`index.ts`)

各 `features/` フォルダは一つの独立したパッケージのように振る舞います。外部からは `index.ts` を通じてのみアクセスを許可し、内部の実装詳細（特定のHooksや内部パーツ）を隠蔽することで、リファクタリングの影響範囲を最小化しています。

---

## 🛠 コンポーネント分割の基準

1. **意味のある塊（Domain Unit）:** 非エンジニアが指を差して名前を呼べる単位か。「このコンポーネントを、エンジニアじゃない人（PMや顧客）に見せたとき、専門用語を使わずにその役割を一言で説明できるか？」
2. **単一責任:** そのコンポーネントの役割を一言で説明できるか。
3. **認知負荷:** JSXが150行を超える場合、親を「目次」にするために分割。
4. **再レンダリング境界:** 高頻度で更新されるパーツ（Input, Timer等）の隔離。

---

## 🧪 テスト戦略

* **Domain Logic:** Vitestによる純粋関数のユニットテスト。
* **UI Parts:** Storybookによるビジュアル確認。
* **Flow:** PlaywrightによるE2Eテスト（主要なユーザーシナリオ）。

---

### 💡 開発者へのメッセージ

このアーキテクチャは、「コードをどこに置くか」の迷いを消し、機能追加が「既存のパズルの組み合わせ」になる状態を目指しています。

---