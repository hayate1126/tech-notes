## ⚠️ エラーハンドリング戦略 (Error Handling Strategy)

「システムは必ず失敗する」という前提に立ち、エラーの影響範囲を最小限に抑えつつ、ユーザーが自己復旧できるための設計を行っています。

### 1. エラー境界による「局所化」 (Graceful Degradation)

エラーの影響範囲に応じて、ハンドリングのレイヤーを使い分けています。

- **Page Level (`error.tsx`):**
    - 初期表示に不可欠なデータ取得が失敗した場合に発動します。
    - ページ全体をエラー表示に切り替え、`reset()` 関数による「再試行ボタン」を提供します。
- **Component Level (`ErrorBoundary`):**
    - フィードの一部やサイドバーなど、特定の Feature で発生したエラーを捕捉します。
    - **「サイドバーは壊れているが、メインコンテンツは閲覧・操作できる」** 状態を維持し、アプリ全体のクラッシュを防ぎます。

### 2. エラーの種類に応じた分類

| エラー種別 | 発生場所 | ハンドリング手法 | ユーザーへのフィードバック |
| :--- | :--- | :--- | :--- |
| **致命的なエラー** | RSC (fetch) | `error.tsx` / `notFound()` | 専用のエラー画面 + 再試行ボタン |
| **部分的なエラー** | RCC (Feature) | `ErrorBoundary` | 代替コンテンツ (Fallback UI) の表示 |
| **期待されるエラー** | Server Actions | `result` オブジェクトを返却 | フォームへのバリデーション表示 / Toast |
| **予期せぬエラー** | 全般 | `Sentry` 等による監視 | バックエンドへのログ送信 + 汎用エラー表示 |



### 3. Server Actions におけるハンドリング

Server Actions 内で `throw` は行わず、原則として **「成功/失敗の状態を含む Result 型」** を返却する設計にしています。

```typescript
// features/post/actions.ts
export async function createPost(data: FormData) {
  try {
    // 処理...
    return { success: true };
  } catch (error) {
    // ログ出力等の共通処理
    return { success: false, message: "投稿に失敗しました。時間をおいて再度お試しください。" };
  }
}

```

これにより、クライアント側で `useFormState` 等を用いて、ページ遷移を伴わないスムーズなエラー表示（トースト通知やインラインメッセージ）を実現しています。

### 4. スキーマバリデーションエラー

APIレスポンスの構造変化によるエラー（Zodのパース失敗）は、早期に検知し `error.tsx` へ委譲します。これにより、型安全性が破壊された状態でレンダリングが進行し、原因不明のランタイムエラーが発生するのを防いでいます。